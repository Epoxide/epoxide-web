name: CI
on:
  push:
    branches:
      - main
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.sha }}
  cancel-in-progress: true
jobs:
  lint: 
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'
      - name: Update npm version
        run: npm update npm -g
      - name: Install dependencies
        run: npm ci
      - name: Run linting
        run: npm run lint
      - name: Validate current commit (last commit) with commitlint
        if: github.event_name == 'push'
        run: npx commitlint --from HEAD~1 --to HEAD --verbose
      - name: Validate PR commits with commitlint
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.head.sha }}~${{ github.event.pull_request.commits }} --to ${{ github.event.pull_request.head.sha }} --verbose
  svelte-check:
    name: Svelte check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'
      - name: Update npm version
        run: npm update npm -g
      - name: Install dependencies
        run: npm ci
      - name: Run Svelte check
        run: npm run check
  test:
    name: Playwright test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: 'package.json'
          cache: 'npm'
      - name: Update npm version
        run: npm update npm -g
      - name: Install dependencies
        run: npm ci
      - name: Install Playwright dependencies
        run: npx playwright install --with-deps
      - name: Run Playwright tests
        run: npm run test
  changes-since-last-deploy:
    name: Compare changes since last deploy
    runs-on: ubuntu-latest
    needs: [lint, svelte-check, test]
    if: github.ref == 'refs/heads/main'
    environment:
      name: github
      url: ${{steps.changes.outputs.url}}
    permissions: read-all
    steps:
      - uses: actions/checkout@v4
      - name: Changes since last deploy
        id: changes
        run: |
          export SHA=$(gh run list --status success --json headSha,status,displayTitle | jq -r '.[0].headSha')
          echo "url=https://github.com/${{ github.repository }}/compare/$SHA...${{ github.sha }}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}
  deploy-production:
    name: Deploy to production
    runs-on: ubuntu-latest
    needs: [changes-since-last-deploy]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://epoxide.se
    concurrency:
      group: production
      cancel-in-progress: true
    env:
      DEPLOY_DIRECTORY: ${{ secrets.DEPLOY_DIRECTORY }}
      DEPLOY_NVM_DIRECTORY: ${{ secrets.DEPLOY_NVM_DIRECTORY }}
    steps:
      - name: Configure SSH
        env:
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy
          chmod 600 ~/.ssh/deploy
          cat >>~/.ssh/config <<END
          Host production
            HostName $DEPLOY_HOST
            User $DEPLOY_USER
            IdentityFile ~/.ssh/deploy
            StrictHostKeyChecking no
          END
      - name: Pull latest
        run: ssh production "cd $DEPLOY_DIRECTORY && git pull"
      - name: Install dependencies
        run: ssh production "cd $DEPLOY_DIRECTORY && . $DEPLOY_NVM_DIRECTORY/nvm.sh --no-use && nvm use && npm install"
      - name: Build
        run: ssh production "cd $DEPLOY_DIRECTORY && . $DEPLOY_NVM_DIRECTORY/nvm.sh --no-use && nvm use && npm run build"
      - name: Restart server
        run: ssh production "cd $DEPLOY_DIRECTORY && . $DEPLOY_NVM_DIRECTORY/nvm.sh --no-use && nvm use && pm2 restart npm -- start"
